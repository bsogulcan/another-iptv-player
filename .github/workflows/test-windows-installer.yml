name: Test Windows Installer

on:
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - 'windows/installer.nsi'
      - '.github/workflows/test-windows-installer.yml'

jobs:
  build-windows-installer:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.35.7'
          channel: 'stable'
      - name: Install dependencies
        run: flutter pub get
      - name: Generate files
        run: flutter packages pub run build_runner build --delete-conflicting-outputs
      - name: Build Windows
        run: flutter build windows
      - name: Install NSIS
        run: choco install nsis -y
      - name: Create Windows Installer
        shell: pwsh
        run: |
          cd windows
          $env:Path = [System.Environment]::GetEnvironmentVariable("Path","Machine") + ";" + [System.Environment]::GetEnvironmentVariable("Path","User")
          makensis installer.nsi
          if (Test-Path "another-iptv-player-windows-setup.exe") {
            Move-Item "another-iptv-player-windows-setup.exe" "..\another-iptv-player-windows-setup-test.exe"
          } else {
            Write-Error "Installer file not found!"
          }
      - name: Create Windows Installer ZIP
        run: |
          7z a another-iptv-player-windows-setup-test.zip another-iptv-player-windows-setup-test.exe
      - name: Upload Windows Installer Artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-installer-test
          path: another-iptv-player-windows-setup-test.zip
          retention-days: 7

